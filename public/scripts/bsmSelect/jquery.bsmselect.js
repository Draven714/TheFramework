(function(a){function g(c,b){this.$original=a(c);this.ignoreOriginalChangeEvent=this.ieClick=this.buildingSelect=!1;this.options=b;this.buildDom()}g.prototype={generateUid:function(a){return this.uid=this.options.containerClass+a},buildDom:function(){var c=this,b=this.options;"original"===b.addItemTarget&&a("option",this.$original).each(function(c,b){null===a(b).data("bsm-order")&&a(b).data("bsm-order",c)});for(var e=0;a("#"+this.generateUid(e)).size();e++);this.$select=a("<select>",{"class":b.selectClass, name:b.selectClass+this.uid,id:b.selectClass+this.uid,change:a.proxy(this.selectChangeEvent,this),click:a.proxy(this.selectClickEvent,this)});this.$list=a.isFunction(b.listType)?b.listType(this.$original):a("<"+b.listType+">",{id:b.listClass+this.uid});this.$list.addClass(b.listClass);this.$container=a("<div>",{"class":b.containerClass,id:this.uid});this.buildSelect();this.$original.change(a.proxy(this.originalChangeEvent,this)).wrap(this.$container).before(this.$select);this.$list.parent().length|| this.$original.before(this.$list);this.$original.attr("id")&&a("label[for="+this.$original.attr("id")+"]").attr("for",this.$select.attr("id"));this.$list.delegate("."+b.removeClass,"click",function(){c.dropListItem(a(this).closest("li"));return!1});a.each(b.plugins,function(){this.init(c)})},selectChangeEvent:function(){if(!a.browser.msie||!(7>a.browser.version)||this.ieClick){var c=a("option:selected:eq(0)",this.$select);c.data("orig-option")&&(this.addListItem(c),this.triggerOriginalChange(c.data("orig-option"), "add"));this.ieClick=!1}},selectClickEvent:function(){this.ieClick=!0},originalChangeEvent:function(){this.ignoreOriginalChangeEvent?this.ignoreOriginalChangeEvent=!1:(this.buildSelect(),a.browser.opera&&this.$list.hide().show())},buildSelect:function(){var c=this;this.buildingSelect=!0;this.$select.empty().prepend(a('<option value=""></option>').text(this.$original.attr("title")||this.options.title));this.$list.empty();this.$original.children().each(function(){a(this).is("option")?c.addSelectOption(c.$select, a(this)):a(this).is("optgroup")&&c.addSelectOptionGroup(c.$select,a(this))});this.options.debugMode||this.$original.hide();this.selectFirstItem();this.buildingSelect=!1},addSelectOption:function(c,b){var e=a("<option>",{text:b.text(),val:b.val()}).appendTo(c).data("orig-option",b),d=b.is(":selected"),f=b.is(":disabled");b.data("bsm-option",e);d&&!f?(this.addListItem(e),this.disableSelectOption(e)):!d&&f&&this.disableSelectOption(e)},addSelectOptionGroup:function(c,b){var e=this,d=a("<optgroup>",{label:b.attr("label")}).appendTo(c); b.is(":disabled")&&d.attr("disabled","disabled");a("option",b).each(function(){e.addSelectOption(d,a(this))})},selectFirstItem:function(){a("option:eq(0)",this.$select).attr("selected","selected")},disableSelectOption:function(c){c.addClass(this.options.optionDisabledClass).removeAttr("selected").attr("disabled","disabled").toggle(!this.options.hideWhenAdded);a.browser.msie&&8>a.browser.version&&this.$select.hide().show()},enableSelectOption:function(c){c.removeClass(this.options.optionDisabledClass).removeAttr("disabled").toggle(!this.options.hideWhenAdded); a.browser.msie&&8>a.browser.version&&this.$select.hide().show()},addListItem:function(c){var b,e=c.data("orig-option"),d=this.options;if(e){if(!this.buildingSelect){if(e.is(":selected"))return;e.attr("selected","selected")}b=a("<li>",{"class":d.listItemClass}).append(a("<span>",{"class":d.listItemLabelClass,html:d.extractLabel(c,d)})).append(a("<a>",{href:"#","class":d.removeClass,html:d.removeLabel})).data("bsm-option",c);this.disableSelectOption(c.data("item",b));switch(d.addItemTarget){case "bottom":this.$list.append(b.hide()); break;case "original":var f=e.data("bsm-order"),g=!1;a("."+d.listItemClass,this.$list).each(function(){if(f<a(this).data("bsm-option").data("orig-option").data("bsm-order"))return b.hide().insertBefore(this),g=!0,!1});g||this.$list.append(b.hide());break;default:this.$list.prepend(b.hide())}this.buildingSelect?a.bsmSelect.effects.show(b):(d.showEffect(b),d.highlightEffect(this.$select,b,d.highlightAddedLabel,this.options),this.selectFirstItem())}},dropListItem:function(c){var b=c.data("bsm-option"), e=this.options;b.removeData("item").data("orig-option").removeAttr("selected");(this.buildingSelect?a.bsmSelect.effects.remove:e.hideEffect)(c);this.enableSelectOption(b);e.highlightEffect(this.$select,c,e.highlightRemovedLabel,e);this.triggerOriginalChange(b.data("orig-option"),"drop")},triggerOriginalChange:function(a,b){this.ignoreOriginalChangeEvent=!0;this.$original.trigger("change",[{option:a,value:a.val(),item:a.data("bsm-option").data("item"),type:b}])}};a.fn.bsmSelect=function(c){var b=a.extend({}, a.bsmSelect.conf,c);return this.each(function(){var c=a(this).data("bsmSelect");c||(c=new g(a(this),b),a(this).data("bsmSelect",c))})};a.bsmSelect={};a.extend(a.bsmSelect,{effects:{show:function(a){a.show()},remove:function(a){a.remove()},highlight:function(c,b,e,d){var f=c.attr("id")+d.highlightClass;a("#"+f).remove();b=a("<span>",{"class":d.highlightClass,id:f,html:e+b.children("."+d.listItemLabelClass).first().text()}).hide();c.after(b.fadeIn("fast").delay(50).fadeOut("slow",function(){a(this).remove()}))}, verticalListAdd:function(c){c.animate({opacity:"show",height:"show"},100,function(){a(this).animate({height:"+=2px"},100,function(){a(this).animate({height:"-=2px"},100)})})},verticalListRemove:function(c){c.animate({opacity:"hide",height:"hide"},100,function(){a(this).prev("li").animate({height:"-=2px"},100,function(){a(this).animate({height:"+=2px"},100)});a(this).remove()})}},plugins:{}});a.bsmSelect.conf={listType:"ol",showEffect:a.bsmSelect.effects.show,hideEffect:a.bsmSelect.effects.remove, highlightEffect:a.noop,addItemTarget:"bottom",hideWhenAdded:!1,debugMode:!1,title:"Select...",removeLabel:"remove",highlightAddedLabel:"Added: ",highlightRemovedLabel:"Removed: ",extractLabel:function(a){return a.html()},plugins:[],containerClass:"bsmContainer",selectClass:"bsmSelect",optionDisabledClass:"bsmOptionDisabled",listClass:"bsmList",listItemClass:"bsmListItem",listItemLabelClass:"bsmListItemLabel",removeClass:"bsmListItemRemove",highlightClass:"bsmHighlight"}})(jQuery);